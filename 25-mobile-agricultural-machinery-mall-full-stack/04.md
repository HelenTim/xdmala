# 04-Koa2

> 真实项目 -> 数据 -> 后端 -> 查询数据库 -> 数据返回给后端 -> 后端响应回前端。所以这用的可不是 mock 数据，因此这节课就来讲讲后端的知识！

## ★Koa 安装

- 安装 node：<https://nodejs.org/zh-cn/>
- <https://koa.bootcss.com/>
- Koa 依赖 node v7.6.0 或 ES2015 及更高版本和 async 方法支持
- `npm init -y`
- `npm i koa --save`
- Hello World

1）课程安排

这节讲koa2 -> 下节MongoDB -> 下下节，把学到的koa2+MongoDB知识完整地应用在我们的项目里边

2）Koa

> Koa -- 基于 Node.js 平台的下一代 web 开发框架

1、Koa概述

nodejs这个平台 -> 可以让JS 运行在服务端 -> 可看作是同级别的 -> Node.js 环境下的JS、Python、Php，毕竟它们都可以作为一个网站的后端去开发哈！

Koa 是一个新的 web 框架，由 Express 幕后的原班人马打造，
致力于成为 web 应用和 API 开发领域中的一个更小、更富有表现力、更健壮的基石。

通过利用 async 函数，Koa 帮你丢弃回调函数，并有力地增强错误处理。
Koa 并没有捆绑任何中间件，而是提供了一套优雅的方法，帮助您快速而愉快地编写服务端应用程序。

2、为啥选择Koa2？而不是express？

koa同express都是同一个公司开发的，而现在的koa有两个版本，即1和2，显然用最新的2哈！

3、基于koa的，有两个企业级框架？

- 阿里：[egg - Born to build better enterprise frameworks and apps](https://eggjs.org/)
- 360：[ThinkJS - 使用 ES6/7 特性开发 Node.js 项目，支持 TypeScript](https://thinkjs.org/)

如果掌握好koa的基础知识，那么以上那两个框架，学起来是很简单的!

4、安装koa？

koa是基于node，所以需要安装node，node的安装路径，用默认的或者自定义的无中文路径！

node版本支持：7.6.0及以上，不然，你就升级吧！

koa是脱离我们这个前端项目的，所以我们需要新建一个目录，然后 `yarn init -y` 一下

``` bash
cd am-shop
mkdir src/koa2
cd src/koa2
yarn init -y
yarn add koa
```

安装好后，就写个Hello World！（当你使用一个新东西的时候，你都得写个Hello World！）

require方法，是Node.js 旗下加载模块的方法

而这种模块规范是CommonJS 规范

模块化开发，有很多规范，如：

- requirejs -> amd规范
- seajs -> cmd规范
- es6规范
- node -> CommonJS 规范

node服务需要通过命令行来执行，可不是在浏览器执行js文件


## ★async await

- Js 异步操作解决方案
- async 函数返回 Promise 对象
- await 只能在 async 函数内部使用

1）异步解决方案

- ES6：promise、generator
- ES7：async、await

在koa1里边，generator用得比较多，而koa2则是async和await了

- async函数返回的是promise对象
- 要获取promise的值，用then方法
- 一般来说，async和await是配合起来使用的
- async和await的作用 -> await等待异步任务结束，才会走接下来的同步代码


## ★get/post 请求接收

- get & post 区别
- query & querystring 区别
  - query：返回的是格式化好的参数对象
  - querystring：返回的是请求字符串
- get 接收参数
- post 接收参数

- koa-bodyparser
- `npm i koa-bodyparser --save`

1）如何用koa实现一个get和post请求？

1、get发请求，koa如何接收请求以及如何拿到参数？

``` js
app.use(ctx => {
  let url = ctx.url;
  let query = ctx.query; // 对象
  let queryString = ctx.querystring; // 字符串

  ctx.body = {
    url,
    query,
    queryString
  };
});
```

![get请求](assets/img/2020-02-28-15-52-09.png)

> 注意key值是唯一的，如果参数这样的 `xxx=15&xxx=16`，那么后边的xxx 16就会覆盖掉前边的xxx 15
> 
> ctx是个形参，koa会传个参数过来作为实参，里边有很多信息，如请求的是方法？请求头是怎样的？等等，总之它是上下文，
> 
> `localhost:3000?username=xiao` -> 浏览器自动补`/` -> `localhost:3000/?username=xiao`

2、那post呢？

> 稍微麻烦点

1. 创建一个html页面，里边有个form表单
2. action -> 服务器地址；method -> 咩有s，即不是methods，不然，发的是get请求，那么输入的表单数据都在url那里了
3. 后端接收前端发送的post请求，如表单，都是通过name属性接收的！
4. 不管是get还是post请求，必须要有 `ctx.body`，不然会报404错误
5. 必须要解码，不然，传过来的数据有中文的话，是有问题的
6. login.html （`http://127.0.0.1:5500/src/koa2/login.html`）-> 发送请求 -> 返回页面的url `http://localhost:3000/`（与action对应）
7. 拿到的是 `username=123456&password=dada` 这样格式的数据，但这样的数据并不是我们想要的哈！我们需要一个中间件来处理这样的数据！

3、koa-bodyparser？

格式化`username=123456&password=dada`这样的字符串，希望拿到对象格式的数据？

安装：

``` bash
yarn add koa-bodyparser
```

有了这个中间件，针对于post请求来说，可以让我们少写很多代码，如不需要监听了，不需要解码了等等

``` js
// 没有koa-bodyparser，koa拿到的表单数据
'username=123456&password=daada'

// 有koa-bodyparser后。拿到的表单数据
{"username":"123456","password":"daada"}
```

> 本质是洋葱模型

4、我想查看ctx的值？

控制台打印了ctx的值，但是这并不好阅读，于是我把对象值直接通过 `ctx.body`返回给前端，这样得到的对象值就是JSON格式的数据，然后再用JSON工具插件格式化就好了

``` js
app.use(async ctx => {
  console.log(ctx)
  let data = ctx.request.body;
  ctx.body = ctx;
});
```

![ctx的结构](assets/img/2020-02-28-17-45-53.png)

## ★koa-router

- `npm i koa-router --save`
- 配置路由
- 路由前缀 prefix
- 传参

1）后端路由

同前端路由一样，都是对url进行处理

安装：

``` bash
yarn add koa-router
```

> 这些包，在项目上线后还是要用的哈！突然有个问题，那就是后端代码需要打包吗？

**➹：**[为什么不把后端也交给 webpack？ - V2EX](https://www.v2ex.com/t/476935)

**➹：**[jaredpalmer/backpack: 🎒 Backpack is a minimalistic build system for Node.js projects.](https://github.com/jaredpalmer/backpack)


关于讲课：

- 有些代码命名，只是为了演示这个东西的用法而已，不要纠结，如使用koa-router，随便定义一个叫`/abc`的路由，而这样的路由显然在真实项目里边是没有的，但为了演示这个包的用法，就简单随意定义个路由演示一下就好了
- 很多时候只会讲应用层面的东西，而不是底层的东西，如vue原理、koa原理什么的

测试代码里边的细节：

- `app.use(router.routes())` -> `router.routes()`表示可以配很多个路由







## ★cookie

![cookie](assets/img/2020-02-28-11-43-25.png)

## ★模板 ejs

- `npm i koa-views --save`
- `npm i ejs --save`

## ★扩展阅读

- [你真的懂前后端分离吗？ - 云+社区 - 腾讯云](https://cloud.tencent.com/developer/article/1160815)
- [如何部署前端代码](https://www.shymean.com/article/%E5%A6%82%E4%BD%95%E9%83%A8%E7%BD%B2%E5%89%8D%E7%AB%AF%E4%BB%A3%E7%A0%81)