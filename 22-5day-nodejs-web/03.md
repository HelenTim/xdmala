# Koa的原理

> 掌握Koa的原理和中间件开发

## ★讲什么

1. 把「中间件」这个概念讲清楚
2. 注册 -> 登录 -> SQL
3. 下一节课会把web架构里边的中间层给讲清楚

## ★TPR

### <mark>1）学会一个知识点？</mark>

1. 眼到 -> 看视频
2. 手到 -> 动手写
3. 心到 -> 思考为啥要这样写

### <mark>2）前后端的交互？</mark>

前端 -> 发数据 -> 后端 -> 处理数据 -> 返回数据（正常来说会返回数据） -> 前端

这个流程一定要搞清楚，后台其实并咩有那么神秘哈！

### <mark>3）讲什么？</mark>

1. 中间件
2. 用koa实现一个登陆功能（涉及到koa-ejs这个模板东西）

## ★中间件

在koa里边中间件是一个非常重要的概念，结合这个中间件，还会讲到一个洋葱模型！

### <mark>1）什么是中间件？</mark>

我们可以把router理解为一个中间件，当然，在官方的定义里边是这样说的：

> 对用户请求进行过滤和预处理的东西

总之，就是把处理的结果传递下去，而不是说「对客户端进行什么响应」

听起来，「中间件」似乎很复杂的样子，但简单理解起来它就是个「函数」哈！

我们知道「函数」就是实现某种功能的，所以「中间件」也是为了实现某种功能的！

同样，我们定义一个中间件，就写成是一个函数就好了

``` js
let test = ()=>{
  console.log('我是你大桃哥啊！')
}
```

在koa里边，我们koa的实例的use方法，来注册一个中间件

``` js
const app = new Koa()
app.use(test)
```

当前端发起请求的一瞬间，这个中间件函数就会被调用

以上就是关于中间件最基础的雏形了！

### <mark>2）进一步理解中间件</mark>

如果接触过express是很好理解中间件的，不过，一般新人都会直接用koa，所以通过koa来理解中间件是首要选择

`new Router()`其实是一个中间件，虽然我们说中间件是个函数，但是也可以把它理解为一个插件哈

可插件又是用来做啥的呢？——显然是用来扩展功能、丰富功能的

像在koa里边，它本身是没有router这个功能的，所以我们需要require一个koa-router进来，然后通过 `new Router`来扩展koa它有这个路由功能

总之，我们可以把中间件理解为一个实现某种特定功能的插件，但，正如我们前边所提到的，它其实就是一个函数哈！

### <mark>3）中间件具备哪些特点？</mark>

1. 封装了一些处理「完整事件」的功能函数（函数是用来处理某个事情的）
2. 非内置的中间件 -> 安装 -> require进来
3. 封装了一些或许很复杂但肯定是通用的

之前，接触到http等这样的内置的系统模块，其实也可以简单理解成中间件，但一般不会这样说

其实，代码写到最后，你会发现koa、express等它们无非就是去调用各种中间件去实现功能

总之，中间件是一个函数，用来实现某种功能。

总之，中间件就是实现某些功能的封装

### <mark>4）中间件和中间层？</mark>

中间层是一个涉及现代web架构的概念！

### <mark>5）在正儿八经的开发里边，中间件是怎么写的呢？</mark>

之前不正经的写法：

``` js
let test = ()=>{
  console.log('我是你大桃哥啊！')
}
const app = new Koa()
app.use(test)
```

> 不管前端发送啥样的url，都会调用这个test方法

正经的写法，是写成一个匿名函数

``` js
app.use(()=>{
  console.log('我是一个中间件哈')
})
```

> 在实际开发里边，中间件是一个匿名函数哈！

### <mark>6）实现多个中间件？</mark>

我们知道中间件的作用是实现某种功能，那么这就意味着在一个系统里边，需要很多个中间件，于是我们就这样做了：

``` js
app.use(()=>{
  console.log('中间件1')
})
app.use(()=>{
  console.log('中间件2')
})
app.use(()=>{
  console.log('中间件3')
})
// ……
```

然而测试，即随便访问一个url，后台只调用了第一个定义的「中间件1」，其余的中间件并没有调用。

所以在这个时候，引入了 `ctx`、 `next`这俩个东西

这两个东西，是koa封装好的，它们分表代表着：

- ctx -> 上下文对象
- next -> 指向下一个中间件函数（中间件是一个函数，所以可以直接调用）

那么此时的做法：

``` js
app.use((ctx,next)=>{
  console.log('中间件1')
  next()
})
app.use((ctx,next)=>{
  console.log('中间件2')
  next()
})
app.use((ctx,next)=>{
  console.log('中间件3')
  next()
})
// ……
```

再次测试，结果，这三个中间件都被调用了！

可见，use默认可注册多个中间件，但在没有使用next的情况下，是只执行一个中间件的！如果，你要执行多个中间件，那么你就得next一下

总之，默认情况下，koa执行第一个中间件，而如果要执行后续的中间件，那么则需要开发者自己next调用一下

### <mark>7）写个稍微复杂点的中间件？</mark>

> 猜测执行顺序

``` js
app.use((ctx,next)=>{
  console.log('1')
  next()
  console.log('2')
})
app.use((ctx,next)=>{
  console.log('3')
  next() //指向的下个中间件是null，即木有，于是就执行 log 4了
  console.log('4')
})
```

测试结果：1 -> 3 -> 4 -> 2

这个执行顺序的原因分析：洋葱模型

### <mark>8）洋葱模型</mark>








































